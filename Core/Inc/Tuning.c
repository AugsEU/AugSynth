#include "Tuning.h"
#include "Midi.h"
#include "Constants.h"
#include "Params.h"

const float_t TwelveTET[24] = 
{
    16.3515978312874140f,
    17.3239144360545048f,
    18.3540479948379769f,
    19.4454364826300576f,
    20.6017223070543665f,
    21.8267644645627463f,
    23.1246514194771500f,
    24.4997147488593257f,
    25.9565435987465740f,
    27.5000000000000000f,
    29.1352350948806205f,
    30.8677063285077509f,
    32.7031956625748279f,
    34.6478288721090095f,
    36.7080959896759396f,
    38.8908729652601153f,
    41.2034446141087471f,
    43.6535289291254855f,
    46.2493028389542999f,
    48.9994294977186655f,
    51.9130871974931409f,
    55.0000000000000000f,
    58.2704701897612409f,
    61.7354126570155017f,
};

const float_t CnJI[24] = // 0
{
    16.3515978312874140f,
    17.0329144075910577f,
    18.3955475601983416f,
    19.6219173975448946f,
    20.4394972891092692f,
    21.8021304417165496f,
    22.9944344502479261f,
    24.5273967469311209f,
    26.1625565300598630f,
    27.2526630521456923f,
    29.4328760963173472f,
    30.6592459336639003f,
    32.7031956625748279f,
    34.0658288151821154f,
    36.7910951203966832f,
    39.2438347950897892f,
    40.8789945782185384f,
    43.6042608834330991f,
    45.9888689004958522f,
    49.0547934938622419f,
    52.3251130601197261f,
    54.5053261042913846f,
    58.8657521926346945f,
    61.3184918673278005f,
};

const float_t CsJI[24] = // 1
{
    16.2411697838010980f,
    17.3239144360545048f,
    18.0457442042234426f,
    19.4894037405613183f,
    20.7886973232654064f,
    21.6548930450681318f,
    23.0985525814060040f,
    24.3617546757016470f,
    25.9858716540817554f,
    27.7182630976872098f,
    28.8731907267575103f,
    31.1830459848981079f,
    32.4823395676021960f,
    34.6478288721090095f,
    36.0914884084468852f,
    38.9788074811226366f,
    41.5773946465308128f,
    43.3097860901362637f,
    46.1971051628120080f,
    48.7235093514032940f,
    51.9717433081635107f,
    55.4365261953744195f,
    57.7463814535150206f,
    62.3660919697962157f,
};

const float_t DnJI[24] = // 2
{
    16.5186431953541764f,
    17.2069199951606002f,
    18.3540479948379733f,
    19.1187999946228899f,
    20.6483039941927196f,
    22.0248575938055673f,
    22.9425599935474658f,
    24.4720639931172954f,
    25.8103799927408986f,
    27.5310719922569618f,
    29.3664767917407588f,
    30.5900799913966246f,
    33.0372863907083527f,
    34.4138399903212004f,
    36.7080959896759467f,
    38.2375999892457799f,
    41.2966079883854391f,
    44.0497151876111346f,
    45.8851199870949316f,
    48.9441279862345908f,
    51.6207599854817971f,
    55.0621439845139236f,
    58.7329535834815175f,
    61.1801599827932492f,
};

const float_t DsJI[24] = // 3
{
    16.2045304021917111f,
    17.5008928343670505f,
    18.2300967024656764f,
    19.4454364826300541f,
    20.2556630027396416f,
    21.8761160429588095f,
    23.3345237791560649f,
    24.3067956032875685f,
    25.9272486435067364f,
    27.3451450536985128f,
    29.1681547239450794f,
    31.1126983722080865f,
    32.4090608043834223f,
    35.0017856687341009f,
    36.4601934049313527f,
    38.8908729652601082f,
    40.5113260054792832f,
    43.7522320859176190f,
    46.6690475583121298f,
    48.6135912065751370f,
    51.8544972870134728f,
    54.6902901073970256f,
    58.3363094478901587f,
    62.2253967444161731f,
};

const float_t EnJI[24] = // 4
{
    16.4813778456434967f,
    17.1681019225453078f,
    18.5415500763489334f,
    19.3141146628634708f,
    20.6017223070543700f,
    21.4601274031816374f,
    23.1769375954361649f,
    24.7220667684652433f,
    25.7521528838179634f,
    27.4689630760724910f,
    28.9711719942952080f,
    30.9025834605815533f,
    32.9627556912869935f,
    34.3362038450906155f,
    37.0831001526978667f,
    38.6282293257269416f,
    41.2034446141087400f,
    42.9202548063632747f,
    46.3538751908723299f,
    49.4441335369304866f,
    51.5043057676359268f,
    54.9379261521449820f,
    57.9423439885904159f,
    61.8051669211631065f,
};

const float_t FnJI[24] = // 5
{
    16.3700733484220571f,
    17.4614115716501956f,
    18.1889703871356190f,
    19.6440880181064692f,
    20.4625916855275705f,
    21.8267644645627428f,
    22.7362129839195255f,
    24.5551100226330874f,
    26.1921173574752899f,
    27.2834555807034285f,
    29.1023526194169904f,
    30.6938875282913557f,
    32.7401466968441142f,
    34.9228231433003913f,
    36.3779407742712380f,
    39.2881760362129384f,
    40.9251833710551409f,
    43.6535289291254855f,
    45.4724259678390510f,
    49.1102200452661748f,
    52.3842347149505798f,
    54.5669111614068569f,
    58.2047052388339807f,
    61.3877750565827114f,
};

const float_t FsJI[24] = // 6
{
    16.2595205293198717f,
    17.3434885646078634f,
    18.4997211355817193f,
    19.2705428495642934f,
    20.8121862775294346f,
    21.6793607057598265f,
    23.1246514194771500f,
    24.0881785619553668f,
    26.0152328469117933f,
    27.7495817033725807f,
    28.9058142743464366f,
    30.8328685593028666f,
    32.5190410586397434f,
    34.6869771292157267f,
    36.9994422711634385f,
    38.5410856991285868f,
    41.6243725550588692f,
    43.3587214115196531f,
    46.2493028389542999f,
    48.1763571239107335f,
    52.0304656938235865f,
    55.4991634067451614f,
    57.8116285486928732f,
    61.6657371186057333f,
};

const float_t GnJI[24] = // 7
{
    16.3331431659062183f,
    17.2263619327917148f,
    18.3747860616444960f,
    19.5997717990874634f,
    20.4164289573827737f,
    22.0497432739733981f,
    22.9684825770556209f,
    24.4997147488593292f,
    25.5205361967284681f,
    27.5621790924667458f,
    29.3996576986311950f,
    30.6246434360741624f,
    32.6662863318124366f,
    34.4527238655834296f,
    36.7495721232889920f,
    39.1995435981749267f,
    40.8328579147655475f,
    44.0994865479467961f,
    45.9369651541112418f,
    48.9994294977186584f,
    51.0410723934569361f,
    55.1243581849334916f,
    58.7993153972623901f,
    61.2492868721483248f,
};

const float_t GsJI[24] = // 8
{
    16.2228397492166074f,
    17.3043623991643791f,
    18.2506947178686829f,
    19.4674076990599261f,
    20.7652348789972585f,
    21.6304529989554766f,
    23.3608892388719127f,
    24.3342596238249094f,
    25.9565435987465669f,
    27.0380662486943422f,
    29.2011115485898891f,
    31.1478523184958789f,
    32.4456794984332078f,
    34.6087247983287511f,
    36.5013894357373587f,
    38.9348153981198521f,
    41.5304697579945099f,
    43.2609059979109460f,
    46.7217784777438183f,
    48.6685192476498116f,
    51.9130871974931409f,
    54.0761324973886914f,
    58.4022230971797853f,
    62.2957046369917649f,
};

const float_t AnJI[24] = // 9
{
    16.4999999999999964f,
    17.1874999999999964f,
    18.3333333333333286f,
    19.3359374999999964f,
    20.6249999999999964f,
    22.0000000000000000f,
    22.9166666666666643f,
    24.7499999999999964f,
    25.7812499999999964f,
    27.4999999999999964f,
    28.6458333333333321f,
    30.9374999999999964f,
    32.9999999999999929f,
    34.3749999999999929f,
    36.6666666666666572f,
    38.6718749999999929f,
    41.2499999999999929f,
    44.0000000000000000f,
    45.8333333333333286f,
    49.4999999999999929f,
    51.5624999999999929f,
    54.9999999999999929f,
    57.2916666666666643f,
    61.8749999999999929f,
};

const float_t AsJI[24] = // 10
{
    16.3885697408703486f,
    17.4811410569283687f,
    18.2095219343003869f,
    19.4234900632537446f,
    20.4857121760879330f,
    21.8514263211604636f,
    23.3081880759044964f,
    24.2793625790671825f,
    26.2217115853925549f,
    27.3142829014505786f,
    29.1352350948806169f,
    30.3492032238339782f,
    32.7771394817406971f,
    34.9622821138567375f,
    36.4190438686007738f,
    38.8469801265074892f,
    40.9714243521758661f,
    43.7028526423209271f,
    46.6163761518089927f,
    48.5587251581343651f,
    52.4434231707851097f,
    54.6285658029011572f,
    58.2704701897612338f,
    60.6984064476679563f,
};

const float_t BnJI[24] = // 11
{
    16.0769303794311256f,
    17.3630848097856152f,
    18.5206237971046548f,
    19.2923164553173478f,
    20.5784708856718375f,
    21.7038560122320163f,
    23.1507797463808203f,
    24.6941650628062064f,
    25.7230886070897995f,
    27.7809356956569822f,
    28.9384746829760218f,
    30.8677063285077580f,
    32.1538607588622511f,
    34.7261696195712304f,
    37.0412475942093096f,
    38.5846329106346957f,
    41.1569417713436749f,
    43.4077120244640327f,
    46.3015594927616405f,
    49.3883301256124128f,
    51.4461772141795990f,
    55.5618713913139644f,
    57.8769493659520435f,
    61.7354126570155159f,
};

const float_t CircleOfFive[24] =
{
    16.3515978312f,
    17.4613986605f,
    18.3955475601f,
    19.6440734931f,
    20.6949910051f,
    22.0995826797f,
    23.2818648807f,
    24.5273967468f,
    26.1920979908f,
    27.5933213401f,
    29.4661102397f,
    31.0424865076f,
    32.7031956624f,
    34.9227973210f,
    36.7910951202f,
    39.2881469862f,
    41.3899820102f,
    44.1991653594f,
    46.5637297614f,
    49.0547934936f,
    52.3841959816f,
    55.1866426802f,
    58.9322204794f,
    62.0849730152f,
};

const float_t Wonky[24] =
{
    16.3996108572911474f,
    17.3027263502995012f,
    18.3667107094612732f,
    19.4669185750924605f,
    20.6121610899170626f,
    21.7253409715513470f,
    23.1602068670617207f,
    24.5174653146844719f,
    25.8729077921368997f,
    27.3260913358965176f,
    29.0663846132304293f,
    31.0032326413978616f,
    32.5115605119456887f,
    34.7381415579818338f,
    36.6347333773852171f,
    38.8033873443308863f,
    41.1237244172131682f,
    43.8399739552231580f,
    46.0396110661405800f,
    48.9654602918107216f,
    51.8940391808894361f,
    55.1528432607369865f,
    58.0877963021987966f,
    61.6869221622303030f,
};

const float_t TwentyFourTET[24] =
{
    65.4063913251199978f,
    67.3229448817255047f,
    69.2956577441865988f,
    71.3261755057731932f,
    73.4161919793185973f,
    75.5674506101606198f,
    77.7817459304849592f,
    80.0609250562840060f,
    82.4068892281801197f,
    84.8215953973982835f,
    87.3070578582113797f,
    89.8653499282197430f,
    92.4986056778666637f,
    95.2090217106325554f,
    97.9988589953928795f,
    100.8704447524680887f,
    103.8261743949391871f,
    106.8685135268481901f,
    109.9999999999501057f,
    113.2232460307327671f,
    116.5409403794696317f,
    119.9558505931239409f,
    123.4708253139750411f,
    127.0887966558923949f,
};

extern float gParameters[128];

const float_t* gLoadedTable;
float_t gOctMultiplier;

void TuningInit()
{
    gLoadedTable = TwelveTET;
}

void UpdateTuning()
{
    uint32_t tuningIdx = EXTRACT_INT_PARAM(gParameters, ASP_TUNING);
    gOctMultiplier = 4.0f;
    switch (tuningIdx)
    {
    case TUNING_12TET:
        gLoadedTable = TwelveTET;
        break;
    case TUNING_Cn_JI: 
        gLoadedTable = CnJI;
        break;
    case TUNING_Cs_JI: 
        gLoadedTable = CsJI;
        break;
    case TUNING_Dn_JI: 
        gLoadedTable = DnJI;
        break;
    case TUNING_Ds_JI: 
        gLoadedTable = DsJI;
        break;
    case TUNING_En_JI: 
        gLoadedTable = EnJI;
        break;
    case TUNING_Fn_JI: 
        gLoadedTable = FnJI;
        break;
    case TUNING_Fs_JI: 
        gLoadedTable = FsJI;
        break;
    case TUNING_Gn_JI: 
        gLoadedTable = GnJI;
        break;
    case TUNING_Gs_JI: 
        gLoadedTable = GsJI;
        break;
    case TUNING_An_JI: 
        gLoadedTable = AnJI;
        break;
    case TUNING_As_JI: 
        gLoadedTable = AsJI;
        break;
    case TUNING_Bn_JI: 
        gLoadedTable = BnJI;
        break;
    case TUNING_24TET: 
        gLoadedTable = TwentyFourTET;
        gOctMultiplier = 2.0f;
        break;
    case CIRCLE_OF_5: 
        gLoadedTable = CircleOfFive;
        break;
    case WONKY: 
        gLoadedTable = Wonky;
        break;
    }
}

/// @brief Convert note index to frequency.
float_t NoteToFreq(uint8_t note)
{
    uint8_t octave = 0;
    while (note >= 24)
    {
        octave++;
        note -= 24;
    }

    float_t freq = gLoadedTable[note];
    // Technically an interupt can happen in between these two but it's rare.
    while (octave > 0)
    {
        freq *= gOctMultiplier;
        octave--;
    }

    return freq;
}